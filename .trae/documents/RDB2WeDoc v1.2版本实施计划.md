# RDB2WeDoc v1.2版本实施计划

## 一、功能模块划分与优先级排序

### 优先级P0（核心功能）
1. **AI智能匹配字段映射功能** - 新功能核心
2. **移除数据映射状态字段** - 修复补丁核心

### 优先级P1（配置优化）
3. **系统配置统一管理** - 配置文件规范化

---

## 二、各功能点具体开发步骤与技术实现路径

### 功能1：AI智能匹配字段映射

#### 2.1.1 创建配置文件结构
- 创建 `/config/config.json` 文件
- 配置项包括：
  - `ai.apiUrl`: OpenAI兼容API地址
  - `ai.apiKey`: API密钥
  - `ai.model`: 使用的模型名称（默认gpt-3.5-turbo）
  - `ai.timeout`: 请求超时时间（默认30秒）
  - `ai.maxRetries`: 最大重试次数（默认3）

#### 2.1.2 创建AI服务模块
- 创建 `/lib/services/ai-mapping.service.ts`
- 实现功能：
  - `suggestFieldMappings()`: 调用AI API进行字段匹配
  - 构建AI提示词，包含源字段和目标字段信息
  - 解析AI返回的JSON结果
  - 错误处理和重试机制

#### 2.1.3 创建API路由
- 创建 `/app/api/ai/field-mapping/route.ts`
- POST接口，接收：
  - `databaseFields`: 源数据库字段数组
  - `documentFields`: 目标文档字段数组
- 返回：AI推荐的字段映射数组

#### 2.1.4 修改创建映射页面
- 在 `/app/mappings/create/page.tsx` 中：
  - 添加"AI智能匹配"按钮（位于"添加字段映射"按钮旁）
  - 添加AI匹配状态（loading、error）
  - 实现 `handleAIMatch()` 函数
  - 调用API并自动填充字段映射列表

#### 2.1.5 修改编辑映射页面
- 在 `/app/mappings/edit/[id]/page.tsx` 中：
  - 同样添加"AI智能匹配"按钮
  - 实现相同的AI匹配逻辑

---

### 功能2：移除数据映射状态字段

#### 2.2.1 修改类型定义
- 在 `/types/index.ts` 中：
  - 删除 `MappingStatus` 类型定义（第317行）
  - 从 `MappingConfig` 接口中移除 `status` 字段（如存在）

#### 2.2.2 修改创建映射页面
- 在 `/app/mappings/create/page.tsx` 中：
  - 删除 `status` 状态变量（第51行）
  - 删除 `formData.status` 初始化（第76行）
  - 删除提交数据中的 `status` 字段（第561行）

#### 2.2.3 修改编辑映射页面
- 在 `/app/mappings/edit/[id]/page.tsx` 中：
  - 删除 `status` 状态变量（第52行）
  - 删除 `formData.status` 初始化（第73行）
  - 删除提交数据中的 `status` 字段

#### 2.2.4 修改MappingFormFields组件
- 在 `/components/mappings/MappingFormFields.tsx` 中：
  - 删除 `status` 和 `onStatusChange` 属性（第37-38行）
  - 删除状态选择器UI（第127-143行）
  - 更新组件接口定义

#### 2.2.5 修改API路由
- 在 `/app/api/mappings/route.ts` 中：
  - 确保不处理 `status` 字段
  - 验证逻辑中移除status相关检查

#### 2.2.6 全局代码检查
- 搜索所有使用 `MappingStatus` 或 `status: 'active' | 'inactive' | 'draft'` 的代码
- 确保所有引用都已清理

---

### 功能3：系统配置统一管理

#### 2.3.1 创建配置加载模块
- 创建 `/lib/config/index.ts`
- 实现配置读取和验证功能
- 提供类型安全的配置访问接口

#### 2.3.2 检查现有配置
- 检查 `.env` 文件中的配置项
- 检查代码中硬编码的配置值
- 将所有系统级配置迁移到 `/config/config.json`

#### 2.3.3 更新服务模块
- 更新 `wecom-document.service.ts` 使用配置文件
- 更新 `database.service.ts` 使用配置文件
- 更新其他需要配置的服务

---

## 三、修复补丁问题定位方法与解决方案

### 问题1：状态字段残留
**定位方法**：
- 使用 Grep 搜索 `status.*active|status.*inactive|status.*draft`
- 搜索 `MappingStatus` 类型引用
- 检查所有映射相关的组件和API

**解决方案**：
- 系统性删除所有status相关代码
- 更新测试用例
- 验证数据存储格式

### 问题2：配置分散
**定位方法**：
- 搜索 `process.env` 使用
- 搜索硬编码的配置值
- 检查各服务模块的配置来源

**解决方案**：
- 统一配置到 `/config/config.json`
- 创建配置管理工具类
- 提供配置验证和默认值

---

## 四、资源分配与时间节点安排

### 阶段1：配置基础设施（2小时）
- 创建配置文件结构
- 实现配置加载模块
- 迁移现有配置

### 阶段2：AI智能匹配功能（6小时）
- 创建AI服务模块（2小时）
- 创建API路由（1.5小时）
- 修改创建页面（1.5小时）
- 修改编辑页面（1小时）

### 阶段3：移除状态字段（3小时）
- 修改类型定义（0.5小时）
- 修改组件（1小时）
- 修改API（0.5小时）
- 全局检查和清理（1小时）

### 阶段4：测试与验证（3小时）
- 单元测试编写（1.5小时）
- 集成测试（1小时）
- 用户验收测试（0.5小时）

**总计：14小时（约2个工作日）**

---

## 五、测试验证策略

### 5.1 单元测试
- **AI服务测试**：
  - 测试提示词构建
  - 测试JSON解析
  - 测试错误处理
  - Mock AI API响应

- **配置模块测试**：
  - 测试配置加载
  - 测试配置验证
  - 测试默认值处理

### 5.2 集成测试
- **AI匹配流程测试**：
  - 测试完整API调用链
  - 测试字段映射自动填充
  - 测试边界情况（空字段、大量字段）

- **映射创建流程测试**：
  - 测试不包含status字段的创建
  - 测试字段映射验证
  - 测试数据持久化

### 5.3 用户验收测试
- **功能验收**：
  - AI智能匹配按钮可用性
  - 匹配结果准确性
  - 状态字段完全移除
  - 配置文件可维护性

- **性能验收**：
  - AI响应时间 < 10秒
  - 页面加载无延迟
  - 配置加载 < 100ms

---

## 六、潜在风险评估与应对措施

### 风险1：AI API不可用或响应慢
**概率**：中
**影响**：高
**应对措施**：
- 实现超时机制
- 提供降级方案（使用本地匹配算法）
- 显示友好的错误提示
- 记录详细日志便于排查

### 风险2：AI返回的JSON格式不正确
**概率**：中
**影响**：中
**应对措施**：
- 实现严格的JSON Schema验证
- 提供错误恢复机制
- 在提示词中明确要求格式
- 实现重试逻辑

### 风险3：移除status字段导致现有数据不兼容
**概率**：低
**影响**：高
**应对措施**：
- 数据迁移脚本处理现有数据
- 向后兼容的读取逻辑
- 充分的测试覆盖
- 备份现有数据

### 风险4：配置文件权限问题
**概率**：低
**影响**：中
**应对措施**：
- 提供配置文件创建向导
- 实现配置验证和错误提示
- 提供默认配置模板
- 文档说明配置要求

---

## 七、阶段性交付物清单

### 阶段1交付物
- [ ] `/config/config.json` 配置文件
- [ ] `/lib/config/index.ts` 配置管理模块
- [ ] 配置迁移文档

### 阶段2交付物
- [ ] `/lib/services/ai-mapping.service.ts` AI服务
- [ ] `/app/api/ai/field-mapping/route.ts` API路由
- [ ] 更新的创建映射页面
- [ ] 更新的编辑映射页面
- [ ] AI服务单元测试

### 阶段3交付物
- [ ] 更新的类型定义文件
- [ ] 更新的MappingFormFields组件
- [ ] 更新的API路由
- [ ] 代码清理报告

### 阶段4交付物
- [ ] 完整的测试套件
- [ ] 测试报告
- [ ] 用户验收测试记录
- [ ] 版本发布说明

### 最终交付物
- [ ] v1.2版本代码
- [ ] 部署文档
- [ ] 配置管理指南
- [ ] AI功能使用文档